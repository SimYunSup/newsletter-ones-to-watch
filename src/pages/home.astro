---
import { getCollection } from "astro:content";
import Layout from "@/components/BasicLayout.astro";
import Post from "@/components/Post.astro";
import Favicon from "@/assets/favicon.svg";
import "@/styles/home.css";

export const prerender = false;
const collection = await getCollection("news");

if (!collection) {
  return Astro.redirect("/404");
}
const list = collection.sort(
  (a, b) => (b.data.properties.날짜?.start.getTime() ?? 0) - (a.data.properties.날짜?.start.getTime() ?? 0))
  .slice(0, 8);
const length = collection.length;
---

<Layout
  pageTitle={"Ones To Watch for FrontEnd"}
  description={"프론트엔드에 대한 정보들을 매주 큐레이션해드립니다."}
>
  <Fragment slot="head">
    <meta
      name="description"
      content="매주 프론트엔드 소식을 정리해서 보내드립니다."
    />
  </Fragment>
  <article class="container section">
    <h1 class="title">
      <Favicon class="logo" />
      <span class="text">Ones To Watch <span class="sub">for</span> FrontEnd</span>
    </h1>
    <h2 class="description">
      매주 프론트엔드 소식을 정리해서 보내드립니다.
    </h2>
    <a href="/news/list/1" class="cta-button" >
      뉴스레터 보러가기
    </a>
  </article>

  <article class="container about-section">
    <div class="about-content">
      <h3 class="about-title">이 뉴스레터는</h3>
      <p class="about-text">
        2023년 9월부터 매주 프론트엔드 생태계에서 일어나는 일들을 정리하고 있습니다.
        React, Next.js, Vite 같은 도구들의 릴리즈 노트부터 CSS 스펙 변경,
        브라우저 업데이트, 커뮤니티에서 논의되는 주제들까지 다룹니다.
      </p>
      <p class="about-text">
        지금까지 발행한 <span class="count-up" data-target={length}>0</span>개의 뉴스레터는 전부 아카이브에서 볼 수 있습니다.
        이메일 구독을 원하시면 아래에서 등록하세요.
      </p>
    </div>
  </article>
  <article class="container card-section">
    <h3 class="card-section-title">최근 뉴스레터</h3>
    <ul
      class="card-grid"
    >
      {
        list.map((post) => (
          <Post post={post} />
        ))
      }
    </ul>
    <div class="newsletter-form">
      <div class="form-title">이메일로 받아보기</div>
      <script async data-uid="c7b118d8c2" src="https://ones-to-watch-for-frontend.kit.com/c7b118d8c2/index.js"></script>
    </div>
  </article>

  <div class="sticky-cta" id="sticky-cta">
    <a href="/news/list/1" class="sticky-cta-button">
      뉴스레터 보러가기
    </a>
  </div>

  <script>
    // Count-up animation
    const countUpElement = document.querySelector('.count-up');
    if (countUpElement) {
      const target = parseInt(countUpElement.getAttribute('data-target') || '0', 10);
      let hasAnimated = false;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !hasAnimated) {
            hasAnimated = true;
            let current = 0;
            const duration = 1500;
            const step = target / (duration / 16);

            const animate = () => {
              current += step;
              if (current < target) {
                countUpElement.textContent = Math.floor(current).toString();
                requestAnimationFrame(animate);
              } else {
                countUpElement.textContent = target.toString();
              }
            };
            animate();
          }
        });
      }, { threshold: 0.5 });

      observer.observe(countUpElement);
    }

    // Sticky CTA button
    const stickyCta = document.getElementById('sticky-cta');
    const heroSection = document.querySelector('.section');

    if (stickyCta && heroSection) {
      const showStickyCta = () => {
        const heroBottom = heroSection.getBoundingClientRect().bottom;
        if (heroBottom < 0) {
          stickyCta.classList.add('visible');
        } else {
          stickyCta.classList.remove('visible');
        }
      };

      window.addEventListener('scroll', showStickyCta);
      showStickyCta();
    }

    // Parallax background
    const parallaxSection = document.querySelector('.section');
    if (parallaxSection) {
      window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        const rate = scrolled * 0.3;
        parallaxSection.style.backgroundPositionY = `${rate}px`;
      });
    }
  </script>
</Layout>
